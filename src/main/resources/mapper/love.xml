<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="shop.mtcoding.blog2.model.LoveRepository">
    <select id="findAll" resultType="shop.mtcoding.blog2.model.Love">
        select * from love_tb
    </select>

    <select id="findByBoardIdAndUserId" resultType="shop.mtcoding.blog2.dto.love.LoveRespDto$LoveBoardRespDto">
        <if test="userId != null">
            SELECT 
            ( select count(*) from love_tb where board_id = #{boardId} ) count,
            ifnull (( select state from love_tb where user_id = #{userId} and board_id = #{boardId} ),0) state
            FROM LOVE_TB
            where board_id = #{boardId} and user_id = #{userId}
        </if>
        <if test="userId == null">
            SELECT 
            ( select count(*) from love_tb where board_id = #{boardId} ) count,
            ifnull (null,0) state
            FROM LOVE_TB
            where board_id = #{boardId} group by board_id
        </if>
    </select>

    <insert id="insertOrUpdate" useGeneratedKeys="true" keyProperty="lDto.id">
        <if test="lDto.id == null">
            INSERT INTO love_tb (user_id, board_id, state) VALUES (#{userId}, #{lDto.boardId}, 1)
        </if>
        <if test="lDto.id != null">
            UPDATE love_tb SET user_id = #{userId}, board_id = #{lDto.boardId}, state = #{lDto.state} WHERE id = #{lDto.id}
        </if>
    </insert>
</mapper>